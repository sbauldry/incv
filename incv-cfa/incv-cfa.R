### Purpose: calculate ordinal omega based on CFA estimates from Mplus
### Author:  S Bauldry
### Date:    June 21, 2020

### Load packages
library(pbivnorm)

### Clear workspace
rm(list = ls())


### Function to calculate ordinal omega
ordinal_omega <- function(lambda, tau, pcm) {
  
  nj <- length(lambda)
  nc <- ncol(tau)
  
  outer_sum1 <- 0
  outer_sum2 <- 0
  
  for(j in 1:nj) {
    for(jp in 1:nj) {
      
      inner_sum1 <- 0
      inner_sum2 <- 0
      inner_sum3 <- 0
      inner_sum4 <- 0
      
      for(c in 1:nc) {
        
        inner_sum3 <- inner_sum3 + pnorm(tau[j,c])
        inner_sum4 <- inner_sum4 + pnorm(tau[jp,c])
        
        for(cp in 1:nc) {
          inner_sum1 <- inner_sum1 + pbivnorm(tau[j,c], tau[jp,cp], lambda[j]*lambda[jp])
          inner_sum2 <- inner_sum2 + pbivnorm(tau[j,c], tau[jp,cp], pcm[j,jp])
        }
      }
      
      outer_sum1 <- outer_sum1 + inner_sum1 - inner_sum3*inner_sum4
      outer_sum2 <- outer_sum2 + inner_sum2 - inner_sum3*inner_sum4
      
    }
  }
  
  ordinal_omega <- outer_sum1/outer_sum2
  return(ordinal_omega)
}


### Estimates for "bad consequences"
bc_full_lam <- cbind(0.704, 0.722, 0.713, 0.678, 0.783, 0.816, 0.778, 0.786, 0.768, 0.725)
bc_full_tau <- cbind( c(-0.571, -0.372,	-0.396,	-0.481,	-0.292,	-0.257,	-0.297,	-0.285,	-0.064,	-0.309), 
                      c( 0.544,	 0.600,	 0.556,	 0.501,	 0.712,	 0.882,	 0.833,	 0.788,	 0.957,	 0.872), 
                      c( 1.184,	 1.186,	 1.196,	 1.127,	 1.464,	 1.608,	 1.558,	 1.484,	 1.562,	1.442) )
bc_full_pcm <- cbind( c(1.000,0.613,0.594,0.542,0.520,0.519,0.494,0.494,0.480,0.437),
                      c(0.613,1.000,0.574,0.574,0.522,0.551,0.519,0.519,0.499,0.480),
                      c(0.594,0.574,1.000,0.536,0.554,0.538,0.523,0.523,0.513,0.457),
                      c(0.542,0.574,0.536,1.000,0.483,0.512,0.468,0.479,0.483,0.504),
                      c(0.520,0.522,0.554,0.483,1.000,0.635,0.606,0.666,0.612,0.577),
                      c(0.519,0.551,0.538,0.512,0.635,1.000,0.684,0.648,0.653,0.605),
                      c(0.494,0.519,0.523,0.468,0.606,0.684,1.000,0.613,0.611,0.599),
                      c(0.494,0.519,0.523,0.479,0.666,0.648,0.613,1.000,0.635,0.587),
                      c(0.480,0.499,0.513,0.483,0.612,0.653,0.611,0.635,1.000,0.579),
                      c(0.437,0.480,0.457,0.504,0.577,0.605,0.599,0.587,0.579,1.000) )
ordinal_omega(bc_full_lam, bc_full_tau, bc_full_pcm)

bc_red_lam <- cbind(0.651, 0.690, 0.677, 0.642, 0.756, 0.803, 0.746, 0.758, 0.747, 0.702)
bc_red_tau <- cbind(c(-0.513, -0.296, -0.330, -0.447, -0.211, -0.178, -0.221, -0.208, 0.019, -0.225), 
                    c( 0.676,  0.737,  0.662,  0.590,  0.853,  1.035,  1.005,  0.932, 1.072,  1.038),
                    c( 1.334,  1.350,  1.321,  1.252,  1.617,  1.765,  1.769,  1.628, 1.717,  1.595) )
bc_red_pcm <- cbind( c(1.000,0.557,0.534,0.471,0.473,0.469,0.430,0.440,0.426,0.388), 
                     c(0.557,1.000,0.516,0.520,0.492,0.514,0.471,0.485,0.461,0.456),
                     c(0.534,0.516,1.000,0.466,0.519,0.502,0.473,0.483,0.482,0.423), 
                     c(0.471,0.520,0.466,1.000,0.442,0.486,0.418,0.421,0.458,0.496),
                     c(0.473,0.492,0.519,0.442,1.000,0.601,0.556,0.620,0.577,0.524),
                     c(0.469,0.514,0.502,0.486,0.601,1.000,0.655,0.613,0.622,0.567),
                     c(0.430,0.471,0.473,0.418,0.556,0.655,1.000,0.573,0.561,0.546), 
                     c(0.440,0.485,0.483,0.421,0.620,0.613,0.573,1.000,0.596,0.546),
                     c(0.426,0.461,0.482,0.458,0.577,0.622,0.561,0.596,1.000,0.545),
                     c(0.388,0.456,0.423,0.496,0.524,0.567,0.546,0.546,0.545,1.000) )
ordinal_omega(bc_red_lam, bc_red_tau, bc_red_pcm)

### Estimates for "good consequences"
gc_full_lam <- cbind(0.712, 0.768, 0.779, 0.789)
gc_full_tau <- cbind( c(-0.508, -0.038, -0.706, -0.312), 
                      c( 0.346,  0.782,  0.277,  0.668),
                      c( 1.298,  1.538,  1.377,  1.480))
gc_full_pcm <- cbind( c(1.000, 0.594, 0.553, 0.512), 
                      c(0.594, 1.000, 0.553, 0.605), 
                      c(0.553, 0.553, 1.000, 0.641),
                      c(0.512, 0.605, 0.641, 1.000))
ordinal_omega(gc_full_lam, gc_full_tau, gc_full_pcm)



### Estimates for trimmed "bad consequences"
bc_full_lam <- cbind(0.789, 0.829, 0.789, 0.805, 0.782)
bc_full_tau <- cbind( c(-0.292, -0.257,	-0.297,	-0.285,	-0.064), 
                      c( 0.712,	 0.882,	 0.833,	 0.788,	 0.957), 
                      c( 1.464,	 1.608,	 1.558,	 1.484,	 1.562) )
bc_full_pcm <- cbind( c(1.000,0.635,0.606,0.666,0.612),
                      c(0.635,1.000,0.684,0.648,0.653),
                      c(0.606,0.684,1.000,0.613,0.611),
                      c(0.666,0.648,0.613,1.000,0.635),
                      c(0.612,0.653,0.611,0.635,1.000) )
ordinal_omega(bc_full_lam, bc_full_tau, bc_full_pcm)


bc_red_lam <- cbind(0.762, 0.817, 0.761, 0.780, 0.761)
bc_red_tau <- cbind( c(-0.205, -0.173,	-0.215,	-0.205,	 0.022), 
                     c( 0.858,	1.045,	 1.019,	 0.942,	 1.083), 
                     c( 1.626,	1.774,	 1.790,	 1.650,	 1.726) )
bc_red_pcm <- cbind( c(1.000,0.601,0.559,0.624,0.584),
                     c(0.601,1.000,0.656,0.617,0.625),
                     c(0.559,0.656,1.000,0.574,0.564),
                     c(0.624,0.617,0.574,1.000,0.600),
                     c(0.584,0.625,0.564,0.600,1.000) )
ordinal_omega(bc_red_lam, bc_red_tau, bc_red_pcm)


